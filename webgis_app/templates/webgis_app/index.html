<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harta GIS</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #toggle-form, #toggle-branch {
            position: absolute;
            left: 10px;
            z-index: 1000;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #toggle-form {
            top: 200px;
            background: #007bff;
        }
        #toggle-branch {
            top: 270px;
            background: #ffc107;
            color: black;
        }
        #form-container, #form-branch {
            display: none;
            position: absolute;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 250px;
        }
        #form-container { top: 320px; }
        #form-branch { top: 500px; }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Harta GIS</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav mr-auto">
            {% if user.is_authenticated %}
                <li class="nav-item">
                    <p class="nav-link">Përshëndetje, {{ user.username }}!</p>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'logout' %}">Dil (Logout)</a>
                </li>
            {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'login' %}">Hyr (Login)</a>
                </li>
            {% endif %}
			<li class="nav-item">
                    <a class="nav-link" href="{% url 'admin:index' %}">Admin</a>
            </li>
			<li class="nav-item">
                    <a class="nav-link" href="{% url 'geojson_view' %}">Kerko</a>
            </li>
			
        </ul>
    </div>
</nav>

<button id="toggle-form" class="btn btn-primary">Shto Pikë</button>
<button id="toggle-branch" class="btn btn-warning">Shto Degë</button>

<div id="form-container" class="card shadow-sm">
    <h3 class="card-header">Shto Pikë</h3>
    <div class="card-body">
        <label for="location-name">Emri:</label>
        <input type="text" class="form-control mb-2" id="location-name">
        <label for="location-city">Qyteti:</label>
        <input type="text" class="form-control mb-2" id="location-city">
        <label for="location-branch">Dega:</label>
        <input type="text" class="form-control mb-2" id="location-branch">
        <label for="location-type">Tipi i klientit:</label>
        <select id="location-type" class="form-control mb-2">
            <option value="">Zgjidh tipin</option>
            <option value="biznes">Biznes</option>
            <option value="individ">Individ</option>
        </select>
        <button class="btn btn-success mt-2" onclick="savePoint()">Ruaj</button>
        <button class="btn btn-secondary mt-2" onclick="closeForm()">Mbyll</button>
    </div>
</div>

<div id="form-branch" class="card shadow-sm">
    <h3 class="card-header">Shto Degë</h3>
    <div class="card-body">
        <label for="branch-name">Emri Degës:</label>
        <input type="text" class="form-control mb-2" id="branch-name">
        <label for="branch-city">Qyteti:</label>
        <input type="text" class="form-control mb-2" id="branch-city">
        <button class="btn btn-success mt-2" onclick="saveBranch()">Ruaj Degë</button>
        <button class="btn btn-secondary mt-2" onclick="closeBranchForm()">Mbyll</button>
    </div>
</div>

<!-- Legjenda -->
<div class="legend">
    <strong>Legjenda:</strong><br>
    <img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png"> Biznes<br>
    <img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Individ<br>
    <img src="https://maps.google.com/mapfiles/ms/icons/green-dot.png"> Degë
</div>

<div id="map"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    var map = L.map('map').setView([41.3275, 19.8189], 13);
    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    var wmsLayer = L.tileLayer.wms("https://geoportal.asig.gov.al/service/adresar/ows?", {
        layers: 'adr_numertim', format: 'image/png', transparent: true
    });

    var baseMaps = { "OpenStreetMap": osmLayer, "Satelit": satelliteLayer };
    var overlays = { "WMS Layer": wmsLayer };
    L.control.layers(baseMaps, overlays).addTo(map);

    var markers = L.markerClusterGroup();
    var branchesLayer = L.layerGroup().addTo(map);
    map.addLayer(markers);

    L.Control.geocoder().addTo(map);

    function loadPointsAndBranches() {
        Promise.all([
            fetch('/api/locations/').then(res => res.json()),
            fetch('/branches_geojson/').then(res => res.json())
        ]).then(([locations, branches]) => {
            markers.clearLayers();
            branchesLayer.clearLayers();

            locations.features.forEach(f => {
                var iconUrl = f.properties.type_client === 'biznes'
                    ? 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    : 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
                var icon = L.icon({ iconUrl: iconUrl, iconSize: [25, 41], iconAnchor: [12, 41] });
                var marker = L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], { icon });
                marker.bindPopup(`<b>${f.properties.name}</b><br>Qyteti: ${f.properties.city}<br>Dega: ${f.properties.branch}<br>Tipi: ${f.properties.type_client}`);
                markers.addLayer(marker);
            });

            branches.features.forEach(f => {
                var branchMarker = L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                    icon: L.icon({
                        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                        iconSize: [25, 41], iconAnchor: [12, 41]
                    })
                });
                branchMarker.bindPopup(`<b>${f.properties.name}</b><br>Qyteti: ${f.properties.city}<br>Përdorues: ${f.properties.user_name}`);
                branchesLayer.addLayer(branchMarker);
            });
        });
    }

    map.on('moveend', loadPointsAndBranches);
    loadPointsAndBranches();

    var newMarker;
    document.getElementById('toggle-form').addEventListener('click', function () {
        document.getElementById('form-container').style.display = 'block';
        map.once('click', function (e) {
            if (newMarker) map.removeLayer(newMarker);
            newMarker = L.marker(e.latlng).addTo(map);
            newMarker.lat = e.latlng.lat;
            newMarker.lng = e.latlng.lng;
        });
    });

    function closeForm() {
        document.getElementById('form-container').style.display = 'none';
        if (newMarker) map.removeLayer(newMarker);
    }

    function savePoint() {
        var name = document.getElementById('location-name').value;
        var city = document.getElementById('location-city').value;
        var branch = document.getElementById('location-branch').value;
        var type_client = document.getElementById('location-type').value;

        if (!name || !city || !branch || !type_client || !newMarker) {
            alert("Ju lutem plotësoni të gjitha fushat dhe klikoni në hartë.");
            return;
        }

        fetch('/api/add_location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                name, city, branch, type_client,
                latitude: newMarker.lat,
                longitude: newMarker.lng
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                alert("Pika u ruajt!");
                location.reload();
            } else {
                alert("Gabim: " + data.message);
            }
        });

        closeForm();
    }

    var newBranchMarker;
    document.getElementById('toggle-branch').addEventListener('click', function () {
        document.getElementById('form-branch').style.display = 'block';
        map.once('click', function (e) {
            if (newBranchMarker) map.removeLayer(newBranchMarker);
            newBranchMarker = L.marker(e.latlng).addTo(map);
            newBranchMarker.lat = e.latlng.lat;
            newBranchMarker.lng = e.latlng.lng;
        });
    });

    function closeBranchForm() {
        document.getElementById('form-branch').style.display = 'none';
        if (newBranchMarker) map.removeLayer(newBranchMarker);
    }

    function saveBranch() {
        var name = document.getElementById('branch-name').value;
        var city = document.getElementById('branch-city').value;

        if (!name || !city || !newBranchMarker) {
            alert("Ju lutem plotësoni të gjitha fushat dhe klikoni në hartë.");
            return;
        }

        fetch('/api/add_branch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                name, city,
                latitude: newBranchMarker.lat,
                longitude: newBranchMarker.lng
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                alert("Dega u ruajt!");
                location.reload();
            } else {
                alert("Gabim: " + data.message);
            }
        });

        closeBranchForm();
    }
</script>

</body>
</html>
